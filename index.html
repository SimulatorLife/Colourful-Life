<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Colourful Life Simulation</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div id="app" class="app-layout">
      <canvas id="gameCanvas"></canvas>
    </div>
    <script type="module">
      import UIManager from './src/uiManager.js';
      import EventManager from './src/eventManager.js';
      import Stats from './src/stats.js';
      import GridManager from './src/gridManager.js';
      import { drawOverlays } from './src/overlays.js';
      import { computeLeaderboard } from './src/leaderboard.js';

      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      canvas.width = 800;
      canvas.height = 800;
      const cellSize = 10;
      const rows = canvas.height / cellSize;
      const cols = canvas.width / cellSize;
      let lastUpdateTime = 0;

      const eventManager = new EventManager(rows, cols);
      const stats = new Stats(1000);

      const grid = new GridManager(rows, cols, { eventManager, ctx, cellSize, stats });
      const uiManager = new UIManager(update, '#app');

      requestAnimationFrame(update);

      function update() {
        if (uiManager.isPaused()) {
          return;
        }

        const now = performance.now();
        const interval = 1000 / Math.max(1, uiManager.getUpdatesPerSecond());

        if (now - lastUpdateTime >= interval) {
          lastUpdateTime = now;
          stats.resetTick();
          grid.update({
            densityEffectMultiplier: uiManager.getDensityEffectMultiplier(),
            societySimilarity: uiManager.getSocietySimilarity(),
            enemySimilarity: uiManager.getEnemySimilarity(),
            eventStrengthMultiplier: uiManager.getEventStrengthMultiplier(),
          });
          // record current event strength for insight charts
          stats.logEvent(eventManager.currentEvent, uiManager.getEventStrengthMultiplier());
          const snapshot = stats.updateFromGrid(grid);

          uiManager.renderMetrics(stats, snapshot);
        }
        grid.draw();
        // overlays
        drawOverlays(grid, ctx, cellSize, {
          showEnergy: uiManager.getShowEnergy(),
          showDensity: uiManager.getShowDensity(),
          showFitness: uiManager.getShowFitness(),
          maxTileEnergy: GridManager.maxTileEnergy,
        });
        // leaderboard (top 5 by composite fitness)
        const top = computeLeaderboard(grid, 5, GridManager.maxTileEnergy);

        uiManager.renderLeaderboard(top);
        requestAnimationFrame(update);
      }

      // overlays and leaderboard moved to modules
    </script>
  </body>
</html>
