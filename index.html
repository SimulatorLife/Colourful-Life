<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Colourful Life Simulation</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div id="app" class="app-layout">
      <div class="seed-controls" id="seedControls">
        <form id="seedForm" class="seed-form">
          <label for="seedInput">Seed</label>
          <input id="seedInput" name="seed" type="text" inputmode="numeric" />
          <button type="submit">Apply</button>
          <button type="button" id="seedRandom">Randomize</button>
        </form>
        <p class="seed-hint">Normalized seed: <span id="seedDisplay">â€”</span></p>
      </div>
      <canvas id="gameCanvas" width="600" height="600"></canvas>
    </div>
    <script type="module">
      import { createSimulation } from './src/main.js';
      import { createRngController, normalizeSeed } from './src/rng.js';

      const canvas = document.getElementById('gameCanvas');
      const seedInput = document.getElementById('seedInput');
      const seedDisplay = document.getElementById('seedDisplay');
      const seedForm = document.getElementById('seedForm');
      const seedRandomButton = document.getElementById('seedRandom');
      const params = new URLSearchParams(window.location.search);
      const initialSeedParam = params.get('seed');
      const defaultSeedValue =
        initialSeedParam ?? Math.floor(Math.random() * 0xffffffff).toString(16);

      if (!initialSeedParam) {
        params.set('seed', defaultSeedValue);
        const next = `${window.location.pathname}?${params.toString()}`;

        window.history.replaceState({}, '', next);
      }

      const rng = createRngController(initialSeedParam ?? defaultSeedValue);

      if (seedInput) {
        seedInput.value = initialSeedParam ?? defaultSeedValue;
      }

      const updateSeedDisplay = (value) => {
        if (!seedDisplay) return;
        const normalized = normalizeSeed(value);

        seedDisplay.textContent = `0x${normalized.toString(16).padStart(8, '0')}`;
      };

      updateSeedDisplay(seedInput?.value ?? defaultSeedValue);

      seedForm?.addEventListener('submit', (event) => {
        event.preventDefault();
        const nextSeed = (seedInput?.value ?? '').trim();
        const nextParams = new URLSearchParams(window.location.search);

        if (nextSeed) {
          nextParams.set('seed', nextSeed);
        } else {
          nextParams.delete('seed');
        }

        const target = `${window.location.pathname}?${nextParams.toString()}`;

        window.location.assign(target);
      });

      seedRandomButton?.addEventListener('click', () => {
        const randomSeed = Math.floor(Math.random() * 0xffffffff)
          .toString(16)
          .padStart(8, '0');

        if (seedInput) {
          seedInput.value = randomSeed;
          seedInput.focus();
        }

        updateSeedDisplay(randomSeed);
      });

      seedInput?.addEventListener('input', (event) => {
        updateSeedDisplay(event.target.value || defaultSeedValue);
      });

      createSimulation({
        canvas,
        config: {
          cellSize: 5,
        },
        rng,
      });
    </script>
  </body>
</html>
